# Multi-app single container: build Vite apps, run Node backend + Nginx via Supervisor

FROM node:20-slim AS builder

WORKDIR /app

# Install deps for both frontends
COPY pizzashop/package.json  ./pizzashop/
COPY pizzashop/package-lock.json ./pizzashop/
COPY backend-panel/package.json ./backend-panel/
COPY backend-panel/package-lock.json ./backend-panel/

RUN npm ci --prefix pizzashop && npm ci --prefix backend-panel

# Copy sources and build
COPY pizzashop ./pizzashop
COPY backend-panel ./backend-panel

RUN npm run build --prefix pizzashop \
 && npm run build --prefix backend-panel \
    + \



FROM node:20-slim

WORKDIR /app

# Install runtime packages: nginx + supervisor + curl for healthcheck
RUN apt-get update \
 && apt-get install -y --no-install-recommends nginx supervisor curl \
 && rm -rf /var/lib/apt/lists/*

# Copy backend
COPY server/package.json server/package-lock.json ./server/
RUN npm ci --prefix server
COPY server ./server

# Copy built frontends from builder stage
COPY --from=builder /app/pizzashop/dist /var/www/pizzashop
COPY --from=builder /app/backend-panel/dist /var/www/admin

# Nginx config
COPY nginx/nginx.conf /etc/nginx/nginx.conf

# Supervisor config
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Create non-root user for node (optional but recommended)
RUN useradd -ms /bin/bash appuser \
 && chown -R appuser:appuser /app/server \
 && chown -R www-data:www-data /var/www

ENV NODE_ENV=production \
    PORT=3001

EXPOSE 80

# Healthcheck: ping nginx default site
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD curl -f http://localhost/ || exit 1

CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/conf.d/supervisord.conf"]


